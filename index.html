<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Fabric Origin Insights — Asistente</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --card: #1f2937;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #60a5fa;
      --ok: #22c55e;
      --warn: #f59e0b;
      --err: #ef4444;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
      background: linear-gradient(180deg, #0b1022 0%, #0f172a 100%);
      color: var(--text);
      display: grid;
      grid-template-columns: 320px 1fr;
      height: 100vh;
      overflow: hidden;
    }
    aside {
      border-right: 1px solid #0b1220;
      background: var(--panel);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    main { display: grid; grid-template-rows: 1fr auto; height: 100vh; }
    .card {
      background: rgba(31,41,55,0.7);
      border: 1px solid rgba(148,163,184,0.12);
      border-radius: 14px;
      padding: 12px;
    }
    h1 { font-size: 18px; margin: 0 0 8px; color: #f3f4f6; }
    label { font-size: 12px; color: var(--muted); display:block; margin-bottom: 4px; }
    input[type="text"], input[type="url"], select, textarea {
      width: 100%; background: #0b1220; color: var(--text);
      border: 1px solid rgba(148,163,184,0.24); border-radius: 10px;
      padding: 8px 10px; outline: none;
    }
    input[type="checkbox"] { transform: translateY(1px); }
    button {
      background: #0b6cff; color: white; border: 0; border-radius: 10px;
      padding: 8px 10px; cursor: pointer;
    }
    button.secondary { background: #1f2937; border: 1px solid rgba(148,163,184,0.24); }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .row { display: flex; gap: 8px; align-items: center; }
    .stack { display: flex; flex-direction: column; gap: 8px; }
    .grow { flex: 1; }
    .messages { overflow: auto; padding: 16px; }
    .msg { max-width: 900px; padding: 12px 14px; border-radius: 12px; margin: 8px 0; white-space: pre-wrap; }
    .me { background: rgba(96,165,250,0.15); border: 1px solid rgba(96,165,250,0.3); }
    .bot { background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.25); }
    .composer { padding: 12px 16px; border-top: 1px solid rgba(148,163,184,0.12); background: rgba(15,23,42,.6); }
    .pill { padding: 2px 8px; border-radius: 999px; font-size: 11px; border:1px solid rgba(148,163,184,0.24); color: var(--muted);}
    .hint { color: var(--muted); font-size: 12px; }
    .ok { color: var(--ok); } .err { color: var(--err); } .warn { color: var(--warn); }
    a { color: var(--accent); }
  </style>
</head>
<body>

  <aside>
    <div class="card stack">
      <h1>Configuración</h1>
      <div class="stack">
        <label>API base</label>
        <input id="apiBase" type="url" placeholder="https://your-app-runner-domain" />
        <div class="row">
          <button id="pingBtn" class="secondary">Ping /healthz</button>
          <span id="pingStatus" class="pill">-</span>
        </div>
      </div>

      <div class="stack">
        <label>Idioma</label>
        <select id="lang">
          <option value="es">Español</option>
          <option value="en">English</option>
        </select>
      </div>

      <div class="stack">
        <label>Identidad</label>
        <div id="identity" class="hint"></div>
      </div>
    </div>

    <div class="card stack">
      <h1>Autenticación (Cognito PKCE)</h1>
      <div class="stack">
        <label>Dominio Cognito</label>
        <input id="cognitoDomain" type="text" placeholder="https://your-domain.auth.region.amazoncognito.com" />
        <label>Client ID</label>
        <input id="clientId" type="text" placeholder="xxxxxxxxxxxxxxxxxxxxxxxxxx" />
        <label>Redirect URI</label>
        <input id="redirectUri" type="url" placeholder="https://your-frontend-url/index.html" />
      </div>
      <div class="row">
        <button id="loginBtn">Login</button>
        <button id="logoutBtn" class="secondary">Logout</button>
      </div>
      <div class="row">
        <label><input id="sendAuth" type="checkbox" /> Enviar <code>Authorization: Bearer</code> al backend</label>
      </div>
      <div class="stack">
        <div class="hint" id="userInfo">No autenticado.</div>
      </div>
    </div>

    <div class="card stack">
      <h1>Sesión</h1>
      <div class="stack">
        <div class="row"><span class="pill">session_id</span><span id="sessionId" class="hint">–</span></div>
        <div class="row"><button id="resetSession" class="secondary">Reiniciar sesión</button></div>
      </div>
    </div>
  </aside>

  <main>
    <div id="messages" class="messages"></div>

    <div class="composer">
      <div class="row">
        <input id="inputMsg" class="grow" type="text" placeholder="Escribe tu mensaje…" />
        <button id="sendBtn">Enviar</button>
      </div>
      <div id="tip" class="hint" style="margin-top:6px;"></div>
    </div>
  </main>

  <script>
    // ------------------------------------------------------------------------------------
    // I18N (identidad honesta con núcleo tools-first)
    // ------------------------------------------------------------------------------------
    const I18N = {
      es: {
        identity: "Soy el asistente virtual de Fabric Data, basado en herramientas y datos estructurados de Fabric Origin Insights.",
        hello: "¡Hola Rafael! Soy el asistente virtual de Fabric Data. ¿Qué te gustaría descubrir hoy?",
        advice: "Ejemplos: “¿dónde ver Conclave (2024) en Argentina?”, “top en México 2024”, “películas sobre detectives”.",
        localHelp: /^(hola|buenas|ayuda|qu[ií]en eres|qu[eé] puedes hacer|como funciona|cómo funciona)$/i,
        whoAreYou: /(qu[ií]en\s+eres|qu[eé]\s+puedes\s+hacer)/i,
        sent: "Enviando…",
        pingOk: "API ok",
        pingKo: "API sin respuesta",
      },
      en: {
        identity: "I'm Fabric Data's virtual assistant, powered by tools and structured data from Fabric Origin Insights.",
        hello: "Hello Rafael! I’m Fabric Data’s virtual assistant. What would you like to explore today?",
        advice: "Examples: “where to watch Conclave (2024) in Argentina?”, “top in Mexico 2024”, “movies about detectives”.",
        localHelp: /^(hi|hello|help|who are you|what can you do|how it works)$/i,
        whoAreYou: /(who\s+are\s+you|what\s+can\s+you\s+do)/i,
        sent: "Sending…",
        pingOk: "API ok",
        pingKo: "API unreachable",
      }
    };

    // ------------------------------------------------------------------------------------
    // Estado / Storage
    // ------------------------------------------------------------------------------------
    const qs = new URLSearchParams(location.search);
    const $ = (id) => document.getElementById(id);
    const state = {
      lang: localStorage.getItem("lang") || "es",
      apiBase: localStorage.getItem("apiBase") || "",
      sessionId: null,
      tokens: null,     // { id_token, access_token, refresh_token }
      user: null,       // { sub, email, name, ... }
      sendAuth: localStorage.getItem("sendAuth") === "1"
    };

    // ------------------------------------------------------------------------------------
    // Utilidades UI
    // ------------------------------------------------------------------------------------
    function escapeHtml(s) {
      return (s ?? "").toString()
        .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }
    function linkify(text) {
      const urlRe = /https?:\/\/[^\s)]+/g;
      return text.replace(urlRe, (u) => `<a href="${u}" target="_blank" rel="noopener noreferrer">${u}</a>`);
    }
    function normalizeTags(text) {
      return text.replace(/<\/?(result|answer|output)>/gi, "");
    }
    function renderMsg(role, text) {
      const wrap = document.createElement("div");
      wrap.className = "msg " + (role === "user" ? "me" : "bot");
      wrap.innerHTML = linkify(escapeHtml(text));
      $("messages").appendChild(wrap);
      $("messages").scrollTop = $("messages").scrollHeight;
    }

    function setTip() {
      const t = I18N[state.lang];
      $("tip").textContent = t.advice;
    }

    function setIdentity() {
      $("identity").textContent = I18N[state.lang].identity;
    }

    function setLang(v) {
      state.lang = v;
      localStorage.setItem("lang", v);
      setIdentity();
      setTip();
    }

    function setApiBase(v) {
      state.apiBase = v;
      localStorage.setItem("apiBase", v);
    }

    function setSendAuth(flag) {
      state.sendAuth = !!flag;
      localStorage.setItem("sendAuth", flag ? "1" : "0");
    }

    function resolveSessionKey() {
      const sub = state.user?.sub || "anon";
      return `session_id:${sub}`;
    }
    function loadSessionId() {
      const key = resolveSessionKey();
      state.sessionId = localStorage.getItem(key) || null;
      $("sessionId").textContent = state.sessionId || "–";
    }
    function saveSessionId(sid) {
      state.sessionId = sid;
      localStorage.setItem(resolveSessionKey(), sid);
      $("sessionId").textContent = sid || "–";
    }

    // ------------------------------------------------------------------------------------
    // Ping /healthz
    // ------------------------------------------------------------------------------------
    $("pingBtn").addEventListener("click", async () => {
      const base = $("apiBase").value.trim();
      if (!base) return;
      setApiBase(base);
      $("pingStatus").textContent = "…";
      try {
        const r = await fetch(base.replace(/\/+$/,"") + "/healthz", { method: "GET" });
        const ok = r.ok ? "ok" : "ko";
        $("pingStatus").textContent = r.ok ? I18N[state.lang].pingOk : I18N[state.lang].pingKo;
        $("pingStatus").style.color = r.ok ? "var(--ok)" : "var(--err)";
      } catch {
        $("pingStatus").textContent = I18N[state.lang].pingKo;
        $("pingStatus").style.color = "var(--err)";
      }
    });

    // ------------------------------------------------------------------------------------
    // Cognito PKCE
    // ------------------------------------------------------------------------------------
    async function sha256(buf) {
      const enc = new TextEncoder();
      const digest = await crypto.subtle.digest("SHA-256", enc.encode(buf));
      return btoa(String.fromCharCode(...new Uint8Array(digest)))
        .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
    }
    function randomString(len=64) {
      const alphabet = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-._~";
      let s=""; for (let i=0;i<len;i++) s += alphabet[Math.floor(Math.random()*alphabet.length)];
      return s;
    }
    async function startLogin() {
      const domain = $("cognitoDomain").value.trim();
      const clientId = $("clientId").value.trim();
      const redirectUri = $("redirectUri").value.trim();
      if (!domain || !clientId || !redirectUri) { alert("Completa dominio, clientId y redirectUri"); return; }
      sessionStorage.setItem("cognitoDomain", domain);
      sessionStorage.setItem("clientId", clientId);
      sessionStorage.setItem("redirectUri", redirectUri);

      const verifier = randomString(64);
      const challenge = await sha256(verifier);
      sessionStorage.setItem("pkce_verifier", verifier);

      const authUrl = `${domain.replace(/\/+$/,"")}/oauth2/authorize?` + new URLSearchParams({
        response_type: "code",
        client_id: clientId,
        redirect_uri: redirectUri,
        scope: "openid email profile",
        code_challenge_method: "S256",
        code_challenge: challenge
      }).toString();
      location.assign(authUrl);
    }
    async function handleCallback() {
      const code = qs.get("code");
      if (!code) return;
      const domain = sessionStorage.getItem("cognitoDomain");
      const clientId = sessionStorage.getItem("clientId");
      const redirectUri = sessionStorage.getItem("redirectUri");
      const verifier = sessionStorage.getItem("pkce_verifier");
      try {
        const body = new URLSearchParams({
          grant_type: "authorization_code",
          client_id: clientId,
          code,
          redirect_uri: redirectUri,
          code_verifier: verifier
        });
        const resp = await fetch(`${domain.replace(/\/+$/,"")}/oauth2/token`, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body
        });
        const tok = await resp.json();
        if (!resp.ok) throw new Error(JSON.stringify(tok));
        state.tokens = {
          id_token: tok.id_token,
          access_token: tok.access_token,
          refresh_token: tok.refresh_token
        };
        sessionStorage.setItem("tokens", JSON.stringify(state.tokens));
        await fetchUserInfo();
        history.replaceState({}, document.title, location.pathname); // limpia ?code
      } catch (e) {
        console.error("Token exchange error", e);
        renderMsg("assistant", `⚠️ Error de autenticación.\n${e}`);
      }
    }
    async function fetchUserInfo() {
      try {
        const domain = sessionStorage.getItem("cognitoDomain");
        const r = await fetch(`${domain.replace(/\/+$/,"")}/oauth2/userInfo`, {
          headers: { "Authorization": `Bearer ${state.tokens.access_token}` }
        });
        const info = await r.json();
        state.user = info;
        $("userInfo").innerHTML = `Autenticado como <strong>${escapeHtml(info.name || info.email || info.sub)}</strong>`;
        loadSessionId();
      } catch {
        $("userInfo").textContent = "Autenticado (sin userInfo)";
      }
    }
    async function logout() {
      const domain = $("cognitoDomain").value.trim() || sessionStorage.getItem("cognitoDomain") || "";
      const redirectUri = $("redirectUri").value.trim() || sessionStorage.getItem("redirectUri") || location.origin + location.pathname;
      sessionStorage.removeItem("tokens");
      state.tokens = null; state.user = null;
      $("userInfo").textContent = "No autenticado.";
      const url = `${domain.replace(/\/+$/,"")}/logout?${new URLSearchParams({
        client_id: $("clientId").value.trim() || sessionStorage.getItem("clientId") || "",
        logout_uri: redirectUri
      }).toString()}`;
      location.assign(url);
    }

    // ------------------------------------------------------------------------------------
    // Envío a /query
    // ------------------------------------------------------------------------------------
    async function sendMessage() {
      const t = I18N[state.lang];
      const base = $("apiBase").value.trim();
      if (!base) { alert("Configura la API base."); return; }
      setApiBase(base);

      const msg = $("inputMsg").value.trim();
      if (!msg) return;

      // Respuestas locales para evitar llamadas innecesarias
      if (t.localHelp.test(msg) || t.whoAreYou.test(msg)) {
        renderMsg("user", msg);
        renderMsg("assistant", I18N[state.lang].identity);
        $("inputMsg").value = "";
        return;
      }

      renderMsg("user", msg);
      $("sendBtn").disabled = true;
      const body = {
        message: msg,
        language: state.lang,
        session_id: state.sessionId || null,
        user_id: state.user?.sub || null,
        title: null,
        user_name: "Rafael"
      };
      try {
        const headers = { "Content-Type": "application/json" };
        if (state.sendAuth && state.tokens?.id_token) {
          headers["Authorization"] = `Bearer ${state.tokens.id_token}`;
        }
        const r = await fetch(base.replace(/\/+$/,"") + "/query", {
          method: "POST",
          headers,
          body: JSON.stringify(body)
        });
        const data = await r.json().catch(()=> ({}));
        if (!r.ok) {
          const msg = typeof data === "object" ? JSON.stringify(data) : (await r.text());
          throw new Error(`HTTP ${r.status} ${r.statusText}\n${msg}`);
        }
        const clean = normalizeTags(String(data.text || ""));
        renderMsg("assistant", clean || "(respuesta vacía)");
        if (data.session_id) saveSessionId(data.session_id);
      } catch (e) {
        console.error(e);
        renderMsg("assistant", "⚠️ Ocurrió un error al consultar el backend.\n" + String(e));
      } finally {
        $("sendBtn").disabled = false;
        $("inputMsg").value = "";
      }
    }

    // ------------------------------------------------------------------------------------
    // Init
    // ------------------------------------------------------------------------------------
    (function init(){
      $("apiBase").value = state.apiBase;
      $("lang").value = state.lang;
      $("sendAuth").checked = state.sendAuth;
      setIdentity(); setTip();

      $("lang").addEventListener("change", (e)=> setLang(e.target.value));
      $("apiBase").addEventListener("change", (e)=> setApiBase(e.target.value.trim()));
      $("sendAuth").addEventListener("change", (e)=> setSendAuth(e.target.checked));
      $("sendBtn").addEventListener("click", sendMessage);
      $("inputMsg").addEventListener("keydown", (e)=> { if (e.key === "Enter") sendMessage(); });
      $("loginBtn").addEventListener("click", startLogin);
      $("logoutBtn").addEventListener("click", logout);
      $("resetSession").addEventListener("click", ()=> { saveSessionId(""); localStorage.removeItem(resolveSessionKey()); $("sessionId").textContent="–"; });

      // Mensaje de bienvenida
      renderMsg("assistant", I18N[state.lang].hello);
      setTimeout(()=> renderMsg("assistant", I18N[state.lang].advice), 10);

      // Tokens de sesión previa
      const tks = sessionStorage.getItem("tokens");
      if (tks) {
        try { state.tokens = JSON.parse(tks); } catch {}
      }
      handleCallback().then(()=>{
        if (state.tokens && !state.user) fetchUserInfo();
        else loadSessionId();
      });
    })();
  </script>
</body>
</html>
