<script>
/** ====== CONFIG ====== **/
const cognitoDomain = "fabric-llm-auth.auth.us-east-1.amazoncognito.com"; // tu domain de Cognito
const clientId = "2i965jbq7hh115im6fl221m0l"; // tu App client id
const redirectUri = "https://ml-team-fabricdata.github.io/llm-origin-insights/"; // raíz del GH Pages
const scopes = ["openid","email","profile"]; // claims que tu UI necesita
/** ===================== **/

const authzEndpoint = `https://${cognitoDomain}/oauth2/authorize`;
const tokenEndpoint = `https://${cognitoDomain}/oauth2/token`;

function b64url(arr){return btoa(String.fromCharCode(...new Uint8Array(arr))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");}
function randomString(len=64){const r=new Uint8Array(len);crypto.getRandomValues(r);return Array.from(r).map(b=>("0"+b.toString(16)).slice(-2)).join("");}
async function sha256Buf(str){const enc=new TextEncoder();return await crypto.subtle.digest("SHA-256", enc.encode(str));}

async function login(){
  const verifier = randomString(64);
  const challenge = b64url(await sha256Buf(verifier));
  sessionStorage.setItem("pkce_verifier", verifier);

  const url = new URL(authzEndpoint);
  url.searchParams.set("client_id", clientId);
  url.searchParams.set("response_type", "code");
  url.searchParams.set("redirect_uri", redirectUri);
  url.searchParams.set("scope", scopes.join(" "));
  url.searchParams.set("code_challenge_method", "S256");
  url.searchParams.set("code_challenge", challenge);
  window.location.assign(url.toString());
}

async function exchangeCode(code){
  const verifier = sessionStorage.getItem("pkce_verifier");
  if(!verifier){console.error("No PKCE verifier"); return;}

  const body = new URLSearchParams();
  body.set("grant_type","authorization_code");
  body.set("client_id", clientId);
  body.set("redirect_uri", redirectUri);
  body.set("code_verifier", verifier);
  body.set("code", code);

  const resp = await fetch(tokenEndpoint, {
    method:"POST",
    headers:{ "Content-Type":"application/x-www-form-urlencoded" },
    body: body.toString()
  });
  if(!resp.ok){throw new Error("Token exchange failed");}
  const tok = await resp.json();
  sessionStorage.setItem("id_token", tok.id_token);
  sessionStorage.setItem("access_token", tok.access_token);
  sessionStorage.setItem("refresh_token", tok.refresh_token || "");
  // Limpia el ?code= de la URL para evitar reintentos
  const clean = new URL(window.location.href);
  clean.searchParams.delete("code");
  clean.searchParams.delete("state");
  window.history.replaceState({}, "", clean.toString());
}

function parseJwt(t){
  const p = t.split(".")[1];
  return JSON.parse(atob(p.replace(/-/g,"+").replace(/_/g,"/")));
}

async function ensureSession(){
  const url = new URL(window.location.href);
  const code = url.searchParams.get("code");
  let idToken = sessionStorage.getItem("id_token");

  if(code && !idToken){
    try{ await exchangeCode(code); } catch(e){ console.error(e); }
    idToken = sessionStorage.getItem("id_token");
  }

  if(!idToken){
    // No hay sesión → forzamos login
    await login();
    return;
  }

  // Ya hay sesión: puedes leer claims (name, email, picture) y pintar la UI
  const claims = parseJwt(idToken);
  // Ejemplo simple:
  const name = claims.name || claims.email || "Usuario";
  const pic = claims.picture;
  console.log("Logged as:", name, claims.email, pic);

  // TODO: pintar avatar/nombre en tu UI:
  // document.querySelector("#userName").textContent = name;
  // if (pic) document.querySelector("#userAvatar").src = pic;
}

ensureSession();

// Logout helper:
async function logout(){
  sessionStorage.clear();
  const url = new URL(`https://${cognitoDomain}/logout`);
  url.searchParams.set("client_id", clientId);
  url.searchParams.set("logout_uri", redirectUri); // vuelve a tu página pública
  window.location.assign(url.toString());
}
</script>
