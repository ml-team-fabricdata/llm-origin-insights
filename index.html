<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Fabric LLM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f172a; --panel:#0b1220; --card:#111827; --text:#e5e7eb; --muted:#94a3b8;
      --accent:#22d3ee; --chip:#1f2937; --border:#1f2937; --bubble:#0f172a; --you:#1f2937;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol",sans-serif;}
    a{color:var(--accent);text-decoration:none}
    .layout{display:grid;grid-template-columns:280px 1fr;height:100%}
    @media (max-width: 920px){.layout{grid-template-columns:1fr}.sidebar{position:fixed;inset:0 30% 0 0;transform:translateX(-100%);transition:.2s;z-index:40}.sidebar.open{transform:none}}
    .sidebar{background:var(--panel);border-right:1px solid var(--border);padding:16px;overflow:auto}
    .sidebar h2{font-size:14px;color:var(--muted);margin:0 0 8px}
    .sidebar .row{display:flex;gap:8px;margin-bottom:8px}
    .sidebar input[type=text]{width:100%;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:8px;color:var(--text)}
    .sidebar button{background:#111827;border:1px solid var(--border);border-radius:8px;padding:8px 10px;color:var(--text);cursor:pointer}
    .sidebar .small{font-size:12px;color:var(--muted)}
    .toggle{display:none}
    @media (max-width: 920px){.toggle{display:block;position:fixed;z-index:50;top:10px;left:10px;background:var(--card);border:1px solid var(--border);border-radius:10px;padding:8px 10px;color:var(--text);}}

    .main{display:flex;flex-direction:column;height:100%}
    header{display:flex;gap:12px;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border);background:var(--panel)}
    header img{width:32px;height:32px;border-radius:50%;object-fit:cover}
    header .grow{flex:1}
    header .name{font-weight:600}
    header .muted{color:var(--muted);font-size:12px}

    .chat{flex:1;overflow:auto;padding:20px}
    .msg{max-width:980px;margin:0 auto 14px;display:flex;gap:12px}
    .msg .bubble{padding:14px 16px;border-radius:14px;background:var(--card);border:1px solid var(--border);white-space:pre-wrap;line-height:1.5}
    .msg.you .bubble{background:var(--you)}
    .msg .role{width:28px;flex:none;opacity:.8}
    .msg .role img{width:28px;height:28px;border-radius:50%}
    .msg .role .bot{display:inline-block;width:28px;height:28px;border-radius:50%;background:var(--chip);text-align:center;line-height:28px;color:var(--muted);font-weight:700}
    .typing{opacity:.7;font-style:italic}
    .list{margin-top:8px}
    .list li{margin:3px 0;color:var(--muted)}
    .footer{padding:14px;border-top:1px solid var(--border);background:linear-gradient(180deg,rgba(15,23,42,.6),rgba(15,23,42,1))}
    .composer{max-width:980px;margin:0 auto;display:flex;gap:10px}
    textarea{flex:1;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px 14px;color:var(--text);height:56px;resize:none}
    .send{background:var(--accent);border:0;color:#001018;border-radius:12px;padding:0 16px;font-weight:700;cursor:pointer}
    .lang{background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:0 10px}
    .tip{max-width:980px;margin:8px auto 0;color:var(--muted);font-size:12px}
    .hidden{display:none}
  </style>
</head>
<body>
<button class="toggle" id="btnSidebar">☰</button>
<div class="layout">
  <aside class="sidebar" id="sidebar">
    <h2 id="hSession">Sesión</h2>
    <div class="row">
      <img id="avatarSide" src="" alt="avatar" style="width:28px;height:28px;border-radius:50%">
      <div>
        <div id="nameSide" style="font-size:13px;font-weight:600">—</div>
        <div id="emailSide" class="small">—</div>
      </div>
    </div>

    <h2 id="hApi" style="margin-top:14px">API base</h2>
    <div class="row"><input id="apiBase" type="text" placeholder="https://&lt;apprunner&gt;.awsapprunner.com"></div>
    <div class="row">
      <button id="btnSave">Guardar</button>
      <button id="btnPing">Ping</button>
    </div>
    <div id="pingOut" class="small">—</div>

    <h2 id="hActions" style="margin-top:14px">Acciones</h2>
    <div class="row">
      <button id="btnLogout" style="width:100%">Salir</button>
    </div>
    <div id="tokensNote" class="small">Tokens se guardan en sessionStorage.</div>

    <h2 id="hAbout" style="margin-top:14px">Acerca</h2>
    <div id="aboutText" class="small">Interfaz de chat para Origin Insights LLM.</div>
  </aside>

  <section class="main">
    <header>
      <img id="userAvatar" alt="avatar"/>
      <div class="grow">
        <div class="name" id="userName">—</div>
        <div class="muted" id="userEmail">—</div>
      </div>
      <select id="selLang" class="lang">
        <option value="es">es</option>
        <option value="en">en</option>
      </select>
    </header>

    <div class="chat" id="chat"></div>

    <div class="footer">
      <div class="composer">
        <textarea id="input" placeholder="Escribe tu consulta… (Shift+Enter = nueva línea)"></textarea>
        <button class="send" id="btnSend">Enviar</button>
      </div>
      <div id="tip" class="tip">Consejo: puedes escribir un título (“Conclave 2024 en Argentina”), pedir dónde ver en un país, o consultar popularidad (HITS).</div>
    </div>
  </section>
</div>

<script>
/** =========================
 *  I18N
 *  ========================= */
const I18N = {
  es: {
    session: "Sesión",
    apiBase: "API base",
    save: "Guardar",
    ping: "Ping",
    saved: "Guardado.",
    pinging: "→ Ping…",
    pingErr: "Error de red",
    actions: "Acciones",
    logout: "Salir",
    tokensNote: "Tokens se guardan en sessionStorage.",
    about: "Acerca",
    aboutText: "Interfaz de chat para Origin Insights LLM.",
    placeholder: "Escribe tu consulta… (Shift+Enter = nueva línea)",
    send: "Enviar",
    tip: "Consejo: puedes escribir un título (“Conclave 2024 en Argentina”), pedir dónde ver en un país, o consultar popularidad (HITS).",
    typing: "Escribiendo…",
    greet: (name)=> `¡Hola ${escapeHtml(name||"")}! Soy el asistente virtual de Fabric Data. Puedo ayudarte a explorar nuestros datos sobre disponibilidad de contenidos en plataformas de streaming y popularidad (HITS). ¿Qué te gustaría descubrir hoy?`,
    identity: "Soy el asistente virtual de Fabric Data, potenciado por IA generativa con datos de Fabric Origin Insights.",
    needApi: "Configura la API base en la barra lateral.",
    errorConnect: "Ocurrió un error al conectar con el servicio."
  },
  en: {
    session: "Session",
    apiBase: "API base",
    save: "Save",
    ping: "Ping",
    saved: "Saved.",
    pinging: "→ Pinging…",
    pingErr: "Network error",
    actions: "Actions",
    logout: "Sign out",
    tokensNote: "Tokens are stored in sessionStorage.",
    about: "About",
    aboutText: "Chat interface for Origin Insights LLM.",
    placeholder: "Type your query… (Shift+Enter = new line)",
    send: "Send",
    tip: "Tip: try a title (“Conclave 2024 in Argentina”), ask where to watch in a country, or check popularity (HITS).",
    typing: "Typing…",
    greet: (name)=> `Hi ${escapeHtml(name||"")}! I’m Fabric Data’s virtual assistant. I can help you explore our data on streaming availability and popularity (HITS). What would you like to discover today?`,
    identity: "I’m Fabric Data’s virtual assistant, powered by generative AI with Fabric Origin Insights data.",
    needApi: "Set the API base in the sidebar.",
    errorConnect: "There was an error connecting to the service."
  }
};
function getLang(){ return localStorage.getItem("uiLang") || "es"; }
function setLang(l){ localStorage.setItem("uiLang", l); }

/** =========================
 *  CONFIG DE AUTENTICACIÓN
 *  ========================= */
const cognitoDomain = "fabric-llm-auth.auth.us-east-1.amazoncognito.com";
const clientId      = "2i965jqbq7hh1l5im6fl221m0l";
const redirectUri   = "https://ml-team-fabricdata.github.io/llm-origin-insights/";

const scopes        = ["openid","email","profile"];
const authzEndpoint = `https://${cognitoDomain}/oauth2/authorize`;
const tokenEndpoint = `https://${cognitoDomain}/oauth2/token`;
const userInfoEP    = `https://${cognitoDomain}/oauth2/userInfo`;

/** =========================
 *  UI helpers
 *  ========================= */
const $ = s => document.querySelector(s);
const chat = $("#chat");
const input = $("#input");
const sendBtn = $("#btnSend");
const langSel = $("#selLang");
const sidebar = $("#sidebar");
$("#btnSidebar").onclick = ()=> sidebar.classList.toggle("open");

function escapeHtml(str=""){
  return (str+"").replace(/[&<>"]/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[m]));
}
function normalizeTags(text=""){
  // elimina <result>/<answer>/<output> envueltos o sueltos
  const wrap = text.match(/^\s*<(result|answer|output)>\s*([\s\S]*?)\s*<\/\1>\s*$/i);
  let s = wrap ? wrap[2] : text;
  return s.replace(/<\/?(?:result|answer|output)\s*>/gi, "").trim();
}
function linkify(s){
  return s.replace(/https?:\/\/[^\s)<>"]+/g, url=>`<a href="${url}" target="_blank" rel="noopener">${url}</a>`);
}
function renderAssistant(text){
  const clean = normalizeTags(text||"");
  let html = escapeHtml(clean);
  html = html.replace(/\*\*(.*?)\*\*/g, "<b>$1</b>");
  html = linkify(html);
  html = html.replace(/\n/g,"<br>");
  return html;
}
function addMsg({role="assistant", html=""}){
  const row = document.createElement("div");
  row.className = "msg " + (role==="user"?"you":"");
  row.innerHTML = `
    <div class="role">${role==="user"
      ? `<img src="${escapeHtml(session.profile?.picture || fallbackAvatar(session.profile?.name || session.profile?.email))}" alt="u">`
      : `<span class="bot">F</span>`
    }</div>
    <div class="bubble">${html}</div>`;
  chat.appendChild(row);
  chat.scrollTop = chat.scrollHeight;
}
function addTyping(){
  const row = document.createElement("div");
  row.className = "msg";
  row.id = "typing";
  const lang = getLang();
  row.innerHTML = `<div class="role"><span class="bot">F</span></div><div class="bubble typing">${I18N[lang].typing}</div>`;
  chat.appendChild(row);
  chat.scrollTop = chat.scrollHeight;
}
function removeTyping(){
  const t = $("#typing"); if(t) t.remove();
}

/** =========================
 *  Auth (PKCE)
 *  ========================= */
function b64url(arr){return btoa(String.fromCharCode(...new Uint8Array(arr))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}
function randomString(len=64){const r=new Uint8Array(len);crypto.getRandomValues(r);return Array.from(r).map(b=>("0"+b.toString(16)).slice(-2)).join("")}
async function sha256Buf(str){const enc=new TextEncoder();return await crypto.subtle.digest("SHA-256", enc.encode(str))}

function parseJwt(t){try{const p=t.split(".")[1];return JSON.parse(atob(p.replace(/-/g,"+").replace(/_/g,"/")));}catch{ return {}; }}

async function login({prompt}={}){
  const verifier = randomString(64);
  const challenge = b64url(await sha256Buf(verifier));
  sessionStorage.setItem("pkce_verifier", verifier);

  const url = new URL(authzEndpoint);
  url.searchParams.set("client_id", clientId);
  url.searchParams.set("response_type", "code");
  url.searchParams.set("redirect_uri", redirectUri);
  url.searchParams.set("scope", scopes.join(" "));
  url.searchParams.set("code_challenge_method","S256");
  url.searchParams.set("code_challenge", challenge);
  if (prompt) url.searchParams.set("prompt", prompt);
  window.location.assign(url.toString());
}
async function exchangeCode(code){
  const verifier = sessionStorage.getItem("pkce_verifier"); if(!verifier) throw new Error("No PKCE verifier");
  const body = new URLSearchParams();
  body.set("grant_type","authorization_code");
  body.set("client_id", clientId);
  body.set("redirect_uri", redirectUri);
  body.set("code_verifier", verifier);
  body.set("code", code);
  const resp = await fetch(tokenEndpoint,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body});
  if(!resp.ok) throw new Error("Token exchange failed");
  const tok = await resp.json();
  sessionStorage.setItem("id_token", tok.id_token);
  sessionStorage.setItem("access_token", tok.access_token);
  if(tok.refresh_token) sessionStorage.setItem("refresh_token", tok.refresh_token);
  const clean = new URL(location.href); clean.searchParams.delete("code"); clean.searchParams.delete("state"); history.replaceState({},"",clean.toString());
}
async function fetchUserInfo(){
  const at = sessionStorage.getItem("access_token"); if(!at) return null;
  const r = await fetch(userInfoEP,{headers:{Authorization:`Bearer ${at}`}}); if(!r.ok) return null;
  return await r.json();
}
function fallbackAvatar(text){
  const label = (text||"User").trim().slice(0,2).toUpperCase();
  return `https://api.dicebear.com/7.x/initials/svg?seed=${encodeURIComponent(label)}&backgroundColor=b6e3f4&radius=50`;
}

/** =========================
 *  App state
 *  ========================= */
const session = {
  profile:null,
  get apiBase(){ return localStorage.getItem("apiBase") || ""; },
  set apiBase(v){ localStorage.setItem("apiBase", v||""); },
  get sessionIdKey(){ return `session_id:${session.profile?.sub||"anon"}`; },
  get sessionId(){ return localStorage.getItem(session.sessionIdKey) || ""; },
  ensureSessionId(){ if(!session.sessionId){ const id=crypto.randomUUID(); localStorage.setItem(session.sessionIdKey,id);} }
};

/** =========================
 *  Boot + i18n apply
 *  ========================= */
function applyI18N(){
  const lang = getLang();
  document.documentElement.lang = lang;  // ← actualiza <html lang=...>

  $("#hSession").textContent = I18N[lang].session;
  $("#hApi").textContent = I18N[lang].apiBase;
  $("#btnSave").textContent = I18N[lang].save;
  $("#btnPing").textContent = I18N[lang].ping;
  $("#hActions").textContent = I18N[lang].actions;
  $("#btnLogout").textContent = I18N[lang].logout;
  $("#tokensNote").textContent = I18N[lang].tokensNote;
  $("#hAbout").textContent = I18N[lang].about;
  $("#aboutText").textContent = I18N[lang].aboutText;
  $("#input").placeholder = I18N[lang].placeholder;
  $("#btnSend").textContent = I18N[lang].send;
  $("#tip").textContent = I18N[lang].tip;
  langSel.value = lang;
}
langSel.addEventListener("change", ()=>{
  setLang(langSel.value);
  applyI18N();
  addMsg({html: (getLang()==="es" ? "Idioma cambiado a español." : "Language switched to English.")});
});

async function ensureSession(){
  setLang(getLang()); // init if missing
  applyI18N();

  const url = new URL(location.href);
  const code = url.searchParams.get("code");
  let idToken = sessionStorage.getItem("id_token");
  if(code && !idToken){ await exchangeCode(code); idToken = sessionStorage.getItem("id_token"); }

  if(!idToken){ await login(); return; }

  let claims = parseJwt(idToken);
  if(!claims.picture || !claims.name || !claims.email){
    const info = await fetchUserInfo();
    if(info){ claims.picture=claims.picture||info.picture; claims.name=claims.name||info.name; claims.email=claims.email||info.email; }
    if(!claims.picture && !sessionStorage.getItem("forced_consent_once")){
      sessionStorage.setItem("forced_consent_once","1"); await login({prompt:"consent"}); return;
    }
  }
  session.profile = claims;
  session.ensureSessionId();

  // Paint header & sidebar
  $("#userName").textContent = claims.name || claims.given_name || (getLang()==="es"?"Usuario":"User");
  $("#userEmail").textContent = claims.email || "";
  $("#userAvatar").src = claims.picture || fallbackAvatar(claims.name || claims.email);
  $("#nameSide").textContent = $("#userName").textContent;
  $("#emailSide").textContent = $("#userEmail").textContent;
  $("#avatarSide").src = $("#userAvatar").src;

  // Greet once per visit
  const firstName = claims.given_name || (claims.name||"").split(" ")[0] || "";
  addMsg({html: I18N[getLang()].greet(firstName)});

  // Load saved API base
  $("#apiBase").value = session.apiBase;
}
ensureSession().catch(e=>{console.error(e);});

/** =========================
 *  Sidebar actions
 *  ========================= */
$("#btnLogout").onclick = ()=>{
  sessionStorage.clear();
  const url = new URL(`https://${cognitoDomain}/logout`);
  url.searchParams.set("client_id", clientId);
  url.searchParams.set("logout_uri", redirectUri);
  location.assign(url.toString());
};
$("#btnSave").onclick = ()=>{
  session.apiBase = $("#apiBase").value.trim();
  $("#pingOut").textContent = I18N[getLang()].saved;
};
$("#btnPing").onclick = async ()=>{
  const base = (session.apiBase||"").replace(/\/+$/,"");
  if(!base){ $("#pingOut").textContent = I18N[getLang()].needApi; return; }
  $("#pingOut").textContent = I18N[getLang()].pinging;
  try{
    const r = await fetch(`${base}/healthz`, {method:"GET"});
    const j = await r.json();
    $("#pingOut").textContent = `ok:${j.ok} db:${j.db}`;
  }catch(e){ $("#pingOut").textContent = I18N[getLang()].pingErr; }
};

/** =========================
 *  Chat logic (saludo/identidad locales)
 *  ========================= */
const GREETINGS = new Set([
  "hola","buenas","buenas tardes","buenas noches","buen dia","buen día",
  "hello","hi","hey","good morning","good afternoon","good evening","what's up","whats up","que tal","qué tal"
]);
const IDENTITY_RE = /(qu[ié]n eres|qu[eé] eres|who are you|what are you)/i;

async function sendMessage(){
  const base = (session.apiBase||"").replace(/\/+$/,"");
  const msg  = input.value.trim();
  if(!base){ addMsg({html:`<i>${I18N[getLang()].needApi}</i>`}); return; }
  if(!msg) return;

  addMsg({role:"user", html: escapeHtml(msg)});
  input.value = ""; input.style.height = "56px";

  // saludo / identidad local → no golpeamos API
  const norm = msg.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/[.,!?]/g,'').trim();
  if (GREETINGS.has(norm)) {
    const firstName = session.profile?.given_name || (session.profile?.name||"").split(" ")[0] || "";
    addMsg({html: I18N[getLang()].greet(firstName)});
    return;
  }
  if (IDENTITY_RE.test(msg)) {
    addMsg({html: I18N[getLang()].identity});
    return;
  }

  addTyping();
  const payload = {
    message: msg,
    language: getLang(),
    session_id: session.sessionId || null,
    user_id: session.profile?.sub || null,
    title: null,
    user_name: session.profile?.given_name || session.profile?.name || null   // ← enviado al backend
  };

  try{
    const resp = await fetch(`${base}/query`,{
      method:"POST",
      headers:{ "Content-Type":"application/json; charset=utf-8" },
      body: new TextEncoder().encode(JSON.stringify(payload))
    });
    const data = await resp.json();
    removeTyping();

    // Guarda session_id devuelto
    if(data?.session_id){
      localStorage.setItem(session.sessionIdKey, data.session_id);
    }

    // Renderiza siempre el texto que venga del server (ya “natural”)
    let answer = (data?.text ?? "").trim();
    if(!answer) answer = (getLang()==="es" ? "No tengo respuesta para eso todavía." : "I don’t have an answer for that yet.");
    addMsg({html: renderAssistant(answer)});

  }catch(e){
    console.error(e);
    removeTyping();
    addMsg({html:`<i>${I18N[getLang()].errorConnect}</i>`});
  }
}

sendBtn.onclick = sendMessage;
input.addEventListener("keydown",(e)=>{
  if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMessage(); }
});
input.addEventListener("input", ()=>{
  input.style.height = "auto";
  input.style.height = Math.min(160, input.scrollHeight) + "px";
});
</script>
</body>
</html>
