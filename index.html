<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Fabric LLM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Oculta la app hasta que haya sesión */
    #app { display:none; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    #loading { padding: 24px; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    header { display:flex; gap:12px; align-items:center; padding:12px 16px; border-bottom: 1px solid #eee;}
    header img { width:32px; height:32px; border-radius:50%; object-fit:cover; }
    header .grow { flex:1; }
    button { padding:6px 10px; border:1px solid #ddd; border-radius:8px; background:#fafafa; cursor:pointer; }
    main { padding: 16px; }
  </style>
</head>
<body>

<div id="loading">Cargando…</div>

<div id="app">
  <header>
    <img id="userAvatar" alt="avatar" />
    <div class="grow">
      <div id="userName" style="font-weight:600;">Usuario</div>
      <div id="userEmail" style="color:#666; font-size:12px;"></div>
    </div>
    <button onclick="logout()">Salir</button>
  </header>

  <main>
    <!-- Tu UI del chat LLM va aquí -->
    <p>¡Bienvenido/a! Ya estás autenticado. (Aquí renderea tu chat.)</p>
  </main>
</div>

<script>
/** ====== CONFIG: reemplaza estos 3 valores ====== **/
const cognitoDomain = "fabric-llm-auth.auth.us-east-1.amazoncognito.com";
const clientId = "2i965jqbq7hh1l5im6fl221m0l";
const redirectUri = "https://ml-team-fabricdata.github.io/llm-origin-insights/";
/** =============================================== **/

const scopes = ["openid","email","profile"];
const authzEndpoint = `https://${cognitoDomain}/oauth2/authorize`;
const tokenEndpoint = `https://${cognitoDomain}/oauth2/token`;

function b64url(arr){return btoa(String.fromCharCode(...new Uint8Array(arr))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");}
function randomString(len=64){const r=new Uint8Array(len);crypto.getRandomValues(r);return Array.from(r).map(b=>("0"+b.toString(16)).slice(-2)).join("");}
async function sha256Buf(str){const enc=new TextEncoder();return await crypto.subtle.digest("SHA-256", enc.encode(str));}

async function login(){
  const verifier = randomString(64);
  const challenge = b64url(await sha256Buf(verifier));
  sessionStorage.setItem("pkce_verifier", verifier);

  const url = new URL(authzEndpoint);
  url.searchParams.set("client_id", clientId);
  url.searchParams.set("response_type", "code");
  url.searchParams.set("redirect_uri", redirectUri);
  url.searchParams.set("scope", scopes.join(" "));
  url.searchParams.set("code_challenge_method", "S256");
  url.searchParams.set("code_challenge", challenge);
  window.location.assign(url.toString());
}

async function exchangeCode(code){
  const verifier = sessionStorage.getItem("pkce_verifier");
  if(!verifier) throw new Error("No PKCE verifier");

  const body = new URLSearchParams();
  body.set("grant_type","authorization_code");
  body.set("client_id", clientId);
  body.set("redirect_uri", redirectUri);
  body.set("code_verifier", verifier);
  body.set("code", code);

  const resp = await fetch(tokenEndpoint, {
    method:"POST",
    headers:{ "Content-Type":"application/x-www-form-urlencoded" },
    body: body.toString()
  });
  if(!resp.ok) throw new Error("Token exchange failed");

  const tok = await resp.json();
  sessionStorage.setItem("id_token", tok.id_token);
  sessionStorage.setItem("access_token", tok.access_token);
  if (tok.refresh_token) sessionStorage.setItem("refresh_token", tok.refresh_token);

  // Limpia los query params
  const clean = new URL(window.location.href);
  clean.searchParams.delete("code");
  clean.searchParams.delete("state");
  window.history.replaceState({}, "", clean.toString());
}

function parseJwt(t){
  const p = t.split(".")[1];
  return JSON.parse(atob(p.replace(/-/g,"+").replace(/_/g,"/")));
}

function showApp(claims){
  const name = claims.name || claims.given_name || claims.email || "Usuario";
  const email = claims.email || "";
  const picture = claims.picture;

  document.getElementById("userName").textContent = name;
  document.getElementById("userEmail").textContent = email;
  if (picture) document.getElementById("userAvatar").src = picture;

  document.getElementById("loading").style.display = "none";
  document.getElementById("app").style.display = "block";
}

async function ensureSession(){
  const url = new URL(window.location.href);
  const code = url.searchParams.get("code");
  let idToken = sessionStorage.getItem("id_token");

  if(code && !idToken){
    try{ await exchangeCode(code); } catch(e){ console.error(e); }
    idToken = sessionStorage.getItem("id_token");
  }

  if(!idToken){
    await login(); // redirige a Hosted UI (Google @fabricdata.com)
    return;
  }

  // Ya hay sesión → mostrar claims
  const claims = parseJwt(idToken);
  showApp(claims);
}

ensureSession();

function logout(){
  sessionStorage.clear();
  const url = new URL(`https://${cognitoDomain}/logout`);
  url.searchParams.set("client_id", clientId);
  url.searchParams.set("logout_uri", redirectUri);
  window.location.assign(url.toString());
}
</script>
</body>
</html>
